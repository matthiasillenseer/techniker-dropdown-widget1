<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<title>Store Lookup Widget mit Offline-Fallback</title>
<script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; margin: 0; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input[type=text] {
    width: 100%; padding: 8px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px;
    box-sizing: border-box;
  }
  .error { color: red; font-size: 0.9em; margin-top: 6px; display: none; }
</style>
</head>
<body>
  <label for="storeInput">Store-Nummer (4-stellig)</label>
  <input id="storeInput" maxlength="4" inputmode="numeric" placeholder="z. B. 1001" />
  <div id="storeError" class="error">Fehler</div>

  <label for="city">Ort</label>
  <input id="city" type="text" placeholder="Ort" />

  <label for="zip">PLZ</label>
  <input id="zip" type="text" placeholder="Postleitzahl" />

  <label for="street">Straße</label>
  <input id="street" type="text" placeholder="Straße mit Hausnummer" />

<script>
(function(){
  const storeInput = document.getElementById('storeInput');
  const city = document.getElementById('city');
  const zip = document.getElementById('zip');
  const street = document.getElementById('street');
  const storeError = document.getElementById('storeError');

  let storeData = {};
  let onlineDataLoaded = false;

  function parseStaticData(jsonString) {
    try {
      return JSON.parse(jsonString || '{}');
    } catch(e) {
      console.error('Fehler beim Parsen der statischen Store-Daten', e);
      return {};
    }
  }

  function loadOnlineData(url) {
    fetch(url + '?t=' + Date.now())
      .then(res => {
        if(!res.ok) throw new Error('Netzwerkfehler');
        return res.json();
      })
      .then(data => {
        storeData = data;
        onlineDataLoaded = true;
        validateAndFill(); // ggf. neu füllen, falls Daten aktualisiert
      })
      .catch(e => {
        console.warn('Online-Daten konnten nicht geladen werden, nutze statische Daten');
        // onlineDataLoaded bleibt false -> fallback auf statische Daten
      });
  }

  function clearFields() {
    city.value = '';
    zip.value = '';
    street.value = '';
  }

  function fillFields(data) {
    city.value = data.city || '';
    zip.value = data.zip || '';
    street.value = data.street || '';
  }

  function formatOutput(storeNr, cityVal, zipVal, streetVal) {
    return `${storeNr}, ${cityVal}, ${zipVal}, ${streetVal}`;
  }

  function sendData() {
    const formatted = formatOutput(storeInput.value.trim(), city.value.trim(), zip.value.trim(), street.value.trim());
    JFCustomWidget.sendData({value: formatted});
  }

  function validateAndFill() {
    const val = storeInput.value.trim();
    const valid = /^[0-9]{4}$/.test(val);

    storeError.style.display = 'none';
    storeInput.classList.remove('invalid-input');
    clearFields();

    if (!valid) {
      storeError.textContent = 'Store-Nr. muss genau 4 Ziffern enthalten.';
      storeError.style.display = 'block';
      sendData();
      return;
    }

    // Datenquelle: Online oder statisch (Parameter)
    const dataSource = onlineDataLoaded ? storeData : storeDataStatic;

    if (dataSource[val]) {
      fillFields(dataSource[val]);
      sendData();
    } else {
      storeError.textContent = 'Store-Nr. nicht gefunden – bitte manuell eingeben.';
      storeError.style.display = 'block';
      sendData();
    }
  }

  // Variablen für statische Daten aus Benutzerparameter
  let storeDataStatic = {};

  JFCustomWidget.subscribe('ready', function(data){
    storeDataStatic = parseStaticData(data.settings.storeData);
    storeData = storeDataStatic; // initial auf statische Daten setzen

    // Versuch, Online-Daten zu laden, falls URL als Parameter definiert ist
    if (data.settings.dataUrl) {
      loadOnlineData(data.settings.dataUrl);
    }

    storeInput.addEventListener('input', validateAndFill);
    city.addEventListener('input', sendData);
    zip.addEventListener('input', sendData);
    street.addEventListener('input', sendData);
  });

  JFCustomWidget.subscribe('submit', function(){
    sendData();
    const isValid = /^[0-9]{4}$/.test(storeInput.value.trim());
    JFCustomWidget.sendSubmit({
      valid: isValid,
      value: formatOutput(storeInput.value.trim(), city.value.trim(), zip.value.trim(), street.value.trim())
    });
  });
})();
</script>
</body>
</html>
