<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Store Lookup Widget</title>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input { width: 100%; padding: 8px; font-size: 14px; box-sizing: border-box; }
    .error { color: red; font-size: 0.9em; }
  </style>
</head>
<body>

  <label for="storeInput">Store-Nr.:</label>
  <input list="storeList" id="storeInput" placeholder="z. B. 1001" />
  <datalist id="storeList"></datalist>
  <div id="storeError" class="error" style="display:none;">Store-Nr. nicht gefunden</div>

  <label for="city">Ort:</label>
  <input type="text" id="city" readonly />

  <label for="zip">PLZ:</label>
  <input type="text" id="zip" readonly />

  <label for="street">Straße:</label>
  <input type="text" id="street" readonly />

  <script>
    (function(){
      const jsonUrl = 'https://matthiasillenseer.github.io/techniker-dropdown-widget1/storedata.json'; // <== Anpassen!
      let storeData = {};

      const storeInput = document.getElementById('storeInput');
      const datalist = document.getElementById('storeList');
      const storeError = document.getElementById('storeError');
      const city = document.getElementById('city');
      const zip = document.getElementById('zip');
      const street = document.getElementById('street');

      function clearFields() {
        city.value = '';
        zip.value = '';
        street.value = '';
      }

      function fillFields(data) {
        city.value = data.city || '';
        zip.value = data.zip || '';
        street.value = data.street || '';
      }

      function updateWidgetOutput() {
        const output = {
          storeNr: storeInput.value,
          city: city.value,
          zip: zip.value,
          street: street.value
        };
        JFCustomWidget.sendData({ value: output });
      }

      function validateAndFill() {
        const storeNr = storeInput.value.trim();
        const entry = storeData[storeNr];

        clearFields();
        storeError.style.display = 'none';

        if (!entry) {
          storeError.style.display = 'block';
          return;
        }

        fillFields(entry.data);
        updateWidgetOutput();
      }

      function populateDatalist() {
        for (const storeNr in storeData) {
          const opt = document.createElement('option');
          opt.value = storeNr;
          datalist.appendChild(opt);
        }
      }

      function loadData() {
        fetch(jsonUrl + '?t=' + Date.now())
          .then(res => res.json())
          .then(data => {
            storeData = data;
            populateDatalist();
          })
          .catch(err => {
            console.error('Fehler beim Laden der Storedaten', err);
          });
      }

      // Init
      JFCustomWidget.subscribe('ready', function(){
        loadData();
        storeInput.addEventListener('input', validateAndFill);
      });

      JFCustomWidget.subscribe('submit', function(){
        updateWidgetOutput();
        JFCustomWidget.sendSubmit({ 
          valid: city.value !== '', 
          value: {
            storeNr: storeInput.value,
            city: city.value,
            zip: zip.value,
            street: street.value
          }
        });
      });
    })();
  </script>
</body>
</html>
